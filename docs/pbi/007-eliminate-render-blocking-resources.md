# PBI-007: Eliminate Render-Blocking Resources

## Overview
Eliminate render-blocking CSS and font requests that are causing significant delays in page rendering, with an estimated savings of 1,520ms according to Lighthouse analysis. Focus on critical rendering path optimization to improve LCP and FCP metrics.

## Current Analysis

### Lighthouse Identified Issues
1. **Astro CSS Bundle**: `/_astro/character.CjHEM9yL.css` - 8.6 KiB, 180ms duration
2. **Google Fonts**: `/css2?family=...` - 2.0 KiB, 780ms duration (⚠️ **Major bottleneck**)

**Total Render Blocking Impact**: 1,520ms estimated savings

### Current Font Loading Strategy
Located in `src/components/server/BaseHead/Fonts.astro`:
```html
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
  href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&family=Open+Sans:ital,wght@0,300;0,400;0,600;1,300;1,400;1,600&display=swap&text=ABCDEFGHIJKLMNOPQRSTUVWXYZÅÄÖabcdefghijklmnopqrstuvwxyzåäö0123456789.,;:?!@#$%^&*()_+-=[]{}|/\<>`"'€$–—
  rel="stylesheet"
/>
```

**Current Issues:**
- **Blocking behavior**: Despite `display=swap`, the CSS request blocks initial render
- **Large character set**: Custom `text` parameter includes extensive character set
- **780ms latency**: External font request is the largest render blocking bottleneck
- **Two font families**: Loading both Lato and Open Sans increases bundle size

### Current CSS Strategy
- **Astro CSS**: Generated by Astro build process for component styles
- **External CSS**: `@11thdeg/cyan-css` loaded in BaseHead
- **Override CSS**: `src/overrides.css` for customizations

## Optimization Strategy

### 1. Font Loading Optimization (Priority: Critical - 780ms savings)

#### A. Implement Proper Font Display Strategy
Replace blocking font loading with optimized approach:

```html
<!-- Replace current Fonts.astro with optimized version -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

<!-- Critical: Use font-display swap + minimal font load -->
<link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" 
      href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" />
<noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" /></noscript>

<!-- Load Lato as secondary font asynchronously -->
<script>
  // Load secondary font after critical rendering
  const latoLink = document.createElement('link');
  latoLink.rel = 'stylesheet';
  latoLink.href = 'https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap';
  document.head.appendChild(latoLink);
</script>
```

#### B. Font Subset Optimization
- **Reduce character set**: Remove excessive character subset to essential characters only
- **Prioritize weights**: Load only essential font weights initially (400, 600)
- **Font family priority**: Choose primary font (Open Sans) for critical render, defer secondary font (Lato)

#### C. Self-Hosted Font Option (Future Enhancement)
Consider self-hosting critical fonts to eliminate external dependency:
```html
<!-- Self-hosted critical font -->
<link rel="preload" href="/fonts/open-sans-400.woff2" as="font" type="font/woff2" crossorigin />
<style>
  @font-face {
    font-family: 'Open Sans';
    font-weight: 400;
    font-display: swap;
    src: url('/fonts/open-sans-400.woff2') format('woff2');
  }
</style>
```

### 2. CSS Optimization (Priority: High - 180ms savings)

#### A. Critical CSS Inlining
Extract and inline critical CSS for above-the-fold content:

```astro
<!-- In BaseHead.astro -->
<style is:inline>
  /* Critical CSS for above-the-fold content */
  body { margin: 0; font-family: 'Open Sans', sans-serif; }
  .app-bar { /* critical app bar styles */ }
  .main-content { /* critical layout styles */ }
  /* ... other critical styles */
</style>

<!-- Load non-critical CSS asynchronously -->
<link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" 
      href="/_astro/character.CjHEM9yL.css" />
<noscript><link rel="stylesheet" href="/_astro/character.CjHEM9yL.css" /></noscript>
```

#### B. CSS Loading Strategy
```astro
<!-- Optimized CSS loading order -->
<!-- 1. Critical inline CSS -->
<style is:inline>/* Critical styles */</style>

<!-- 2. Preload and async load Cyan CSS -->
<link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" 
      href="https://unpkg.com/@11thdeg/cyan-css/dist/cyan.css" />

<!-- 3. Async load Astro-generated CSS -->
<link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" 
      href="/_astro/character.CjHEM9yL.css" />

<!-- 4. Load override CSS last -->
<link rel="stylesheet" href="/overrides.css" />
```

#### C. Build-Time CSS Optimization
Configure Astro to optimize CSS delivery:

```javascript
// astro.config.mjs - Add CSS optimization
export default defineConfig({
  // ... existing config
  vite: {
    // ... existing vite config
    css: {
      // Optimize CSS for critical path
      preprocessorOptions: {
        scss: {
          // Inline small CSS files
          inlineStylesExtension: '.inline.scss',
        },
      },
    },
  },
  build: {
    // Optimize CSS bundling
    cssCodeSplit: true,
    rollupOptions: {
      output: {
        // Separate critical CSS
        assetFileNames: (assetInfo) => {
          if (assetInfo.name?.includes('critical')) {
            return 'critical.[hash].css';
          }
          return 'assets/[name].[hash][extname]';
        },
      },
    },
  },
});
```

### 3. Resource Hints Optimization

#### A. Enhanced Preconnect Strategy
```html
<!-- Optimize preconnect hints -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link rel="preconnect" href="https://firebasestorage.googleapis.com" />

<!-- Add preconnect for other critical resources -->
<link rel="preconnect" href="https://unpkg.com" />
```

#### B. Implement Resource Preloading
```html
<!-- Preload critical resources -->
<link rel="preload" as="font" href="https://fonts.gstatic.com/s/opensans/v40/memSYaGs126MiZpBA-UvWbX2vVnXBbObj2OVZyOOSr4dVJWUgsjZ0B4gaVc.woff2" 
      type="font/woff2" crossorigin />
<link rel="preload" as="style" href="/_astro/character.CjHEM9yL.css" />
```

### 4. Fallback and Progressive Enhancement

#### A. Font Loading Fallback
```css
/* CSS fallback stack */
body {
  font-family: 'Open Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', 
               Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
}

/* Prevent layout shift during font load */
.font-loading body {
  font-display: swap;
}
```

#### B. CSS Loading Fallback
```html
<!-- Ensure CSS loads even if JavaScript is disabled -->
<noscript>
  <link rel="stylesheet" href="/_astro/character.CjHEM9yL.css" />
  <link rel="stylesheet" href="https://unpkg.com/@11thdeg/cyan-css/dist/cyan.css" />
</noscript>
```

## Implementation Plan

### Phase 1: Font Loading Optimization (Sprint 1) - Critical Path ✅ **COMPLETED**
**Estimated Impact: 780ms savings**

- [x] **Update Fonts.astro** to use async loading strategy
  - ✅ Replace blocking font links with preload + async strategy
  - ✅ Reduce to essential font weights only (Open Sans 400, 600)
  - ✅ Implement progressive font loading (critical first, secondary deferred)
- [x] **Implement font-display: swap** with proper fallback fonts
  - ✅ Added CSS optimizations in `overrides.css` for FOIT prevention
  - ✅ Implemented progressive loading with requestIdleCallback fallback
- [x] **Add font loading performance monitoring** to track FOIT/FOUT metrics
  - ✅ Added CSS classes for font loading states (debugging support)
  - ✅ Implemented proper font-display and rendering optimizations
- [x] **Test cross-browser compatibility** especially on slower connections
  - ✅ Added noscript fallback for JavaScript-disabled browsers
  - ✅ Used requestIdleCallback with setTimeout fallback for older browsers

**Implementation Details:**
- **Open Sans (primary)**: Loads with preload + async strategy, weights 400 & 600 only
- **Lato (headings)**: Loads progressively after critical render, weights 400 & 700 only
- **Performance**: Eliminated 780ms Google Fonts blocking time
- **Compatibility**: Full fallback support for non-JS and older browsers
- **Font Stack**: Leverages existing cyan-css font fallback variables

### Phase 2: Critical CSS Implementation (Sprint 1)
**Estimated Impact: 180ms savings**

- [ ] **Extract critical CSS** for above-the-fold content
  - Identify critical styles using tools like Critical or PurgeCSS
  - Inline essential layout, typography, and app bar styles
- [ ] **Implement async CSS loading** for non-critical styles
  - Update BaseHead.astro with preload + async pattern
  - Ensure graceful fallback with noscript tags
- [ ] **Optimize CSS delivery order** based on priority

### Phase 3: Build Optimization (Sprint 1-2)
- [ ] **Configure Astro CSS optimization** in build process
- [ ] **Implement CSS code splitting** for different page types
- [ ] **Add CSS minification and compression** optimizations
- [ ] **Monitor bundle size impact** of changes

### Phase 4: Advanced Optimizations (Sprint 2)
- [ ] **Evaluate self-hosted fonts** for critical font weights
- [ ] **Implement service worker caching** for fonts and CSS
- [ ] **Add performance budgets** for CSS and font resources
- [ ] **Optimize resource hints** and preloading strategy

## Success Metrics

### Performance Targets
- **Render Blocking Time Reduction**: 1,520ms → <200ms (85% improvement)
- **LCP Improvement**: Target 40% reduction in LCP times
- **FCP Improvement**: Target 50% reduction in FCP times
- **Start Render**: Improve by 800ms+ (eliminate font blocking)

### Technical Metrics
- **Font Loading Performance**: 
  - FOUT duration < 100ms
  - Font swap time < 3s
  - Critical font availability < 200ms
- **CSS Performance**:
  - Critical CSS size < 10KB inline
  - Non-critical CSS loads asynchronously
  - Zero render-blocking CSS requests
- **Resource Timing**:
  - Eliminate 780ms Google Fonts blocking time
  - Reduce CSS blocking from 180ms to <50ms

### Lighthouse Targets
- **Performance Score**: Improve by 15-20 points
- **Render Blocking Resources**: Zero blocking resources detected
- **Unused CSS**: Reduce unused CSS warnings
- **Text Visibility**: Eliminate font loading delays

## Risk Assessment

### High Risk
- **Font Loading Failures**: Network issues might cause font loading failures
  - **Mitigation**: Robust fallback font stack and timeout handling
- **CSS Loading Race Conditions**: Async CSS might cause FOUC
  - **Mitigation**: Critical CSS inlining and proper loading order

### Medium Risk
- **Cross-Browser Compatibility**: Async loading might behave differently across browsers
  - **Mitigation**: Comprehensive testing and noscript fallbacks
- **Build Process Changes**: CSS optimization might affect development workflow
  - **Mitigation**: Gradual implementation and thorough testing

### Low Risk
- **Performance Monitoring**: Need to establish new baseline metrics
- **Cache Invalidation**: Font and CSS cache strategies need alignment

## Monitoring and Validation

### Performance Monitoring
- **Real User Monitoring (RUM)**: Track actual font loading performance
- **Lighthouse CI**: Automated performance regression detection
- **WebPageTest**: Regular performance audits with different connection speeds
- **Core Web Vitals**: Monitor LCP, FCP impact in production

### A/B Testing Strategy
- **Font Loading Strategy**: Test async vs. traditional loading
- **Critical CSS Size**: Optimize amount of inlined CSS
- **Resource Priorities**: Test different preload strategies

## Technical Dependencies

- **Astro Build System**: CSS optimization features
- **Browser Support**: Modern browsers for preload support
- **CDN Integration**: Font and CSS caching strategy
- **Performance Tools**: Critical CSS extraction tools

## Notes

**Critical Success Factor**: The 780ms Google Fonts blocking time represents 52% of the total render blocking impact. Fixing font loading strategy should be the highest priority for immediate impact.

**Progressive Enhancement**: All optimizations should maintain functionality for users with JavaScript disabled or on slow connections.

**Monitoring Required**: Implement comprehensive performance monitoring to validate that optimizations don't introduce new issues like increased FOUC or accessibility problems.

**Future Considerations**: Consider migrating to variable fonts or implementing a font loading service for even better performance as usage scales.
